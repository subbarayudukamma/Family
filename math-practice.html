<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Strong - Get better at basic math.</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            touch-action: manipulation;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            position: relative;
        }

        .info-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-weight: bold;
            z-index: 10;
            touch-action: manipulation;
        }

        .info-icon:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .modal-body {
            color: #333;
            line-height: 1.8;
        }

        .modal-body p {
            margin-bottom: 15px;
        }

        .modal-body strong {
            color: #667eea;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 20px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .table-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .table-btn {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .table-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .mix-all-btn {
            margin-top: 20px;
            padding: 20px;
            font-size: 1.3em;
            border: 3px solid #764ba2;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .mix-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .question-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 30px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-input {
            width: 100%;
            padding: 20px;
            font-size: 2em;
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .keypad.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .key {
            padding: 20px;
            font-size: 1.5em;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
            touch-action: manipulation;
        }

        .key:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .key:active {
            transform: scale(0.95);
        }

        .key.wide {
            grid-column: span 3;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-buttons.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .btn-enter {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-exit {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .feedback {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            max-width: 80%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .feedback.correct {
            background: #4CAF50;
            color: white;
        }

        .feedback.incorrect {
            background: #f44336;
            color: white;
        }

        .stats {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            font-size: 1.2em;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: bold;
            color: #667eea;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
        }

        .running-stats {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .running-stats.visible {
            display: flex;
        }

        .running-stat-item {
            font-size: 1em;
            font-weight: 600;
        }

        .running-stat-time {
            color: #667eea;
        }

        .running-stat-score {
            color: #333;
        }

        .running-stat-correct {
            color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .question-display {
                font-size: 2em;
                padding: 30px;
            }

            .answer-input {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <button class="info-icon" onclick="showInfoModal()" title="Information">‚ìò</button>
            <h1>üéì Math Strong</h1>
            <h2>Amazing, you are determined to get better!</h2>
            <h2>What do you want to practice?</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="selectMode('addition')">
                    ‚ûï Addition
                </button>
                <button class="btn btn-primary" onclick="selectMode('subtraction')">
                    ‚ûñ Subtraction
                </button>
                <button class="btn btn-primary" onclick="selectMode('multiplication')">
                    ‚úñÔ∏è Multiplication
                </button>
                <button class="btn btn-primary" onclick="selectMode('division')">
                    ‚ûó Division
                </button>
                <button class="btn btn-primary" onclick="selectMode('mixall')" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%); margin-top: 10px;">
                    üé≤ Mix Everything!
                </button>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                <label style="display: flex; align-items: center; font-size: 1.1em; cursor: pointer; margin-bottom: 15px;">
                    <input type="checkbox" id="negativeCheckbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                    <span>Include negative numbers. I'm ready!</span>
                </label>
                <label style="display: flex; align-items: center; font-size: 1.1em; cursor: pointer;">
                    <input type="checkbox" id="showRunningStatsCheckbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                    <span>Show running stats during practice</span>
                </label>
            </div>
        </div>

        <!-- Table Selection Screen -->
        <div id="tableScreen" class="screen">
            <h1 id="tableTitle">Choose a Table</h1>
            <h2 id="tablePrompt">Select a multiplication table (0-12)</h2>
            <div class="table-selector" id="tableSelector"></div>
            <button class="mix-all-btn" id="mixAllBtn" onclick="selectTable('mix')">
                üé≤ Mix All Tables
            </button>
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="goHome()">
                    ‚Üê Back to Home
                </button>
            </div>
        </div>


        <!-- Practice Screen -->
        <div id="practiceScreen" class="screen">
            <div class="running-stats" id="runningStats">
                <span class="running-stat-item running-stat-time" id="runningTime">0.0s</span>
                <span class="running-stat-item running-stat-score">
                    <span class="running-stat-correct" id="runningCorrect">0</span>/<span id="runningTotal">0</span>
                </span>
            </div>
            <div class="question-display" id="questionDisplay"></div>
            <input type="text" id="answerInput" class="answer-input" readonly placeholder="Use keypad or keyboard">
            <div class="keypad">
                <button class="key" onclick="inputDigit('1')">1</button>
                <button class="key" onclick="inputDigit('2')">2</button>
                <button class="key" onclick="inputDigit('3')">3</button>
                <button class="key" onclick="inputDigit('4')">4</button>
                <button class="key" onclick="inputDigit('5')">5</button>
                <button class="key" onclick="inputDigit('6')">6</button>
                <button class="key" onclick="inputDigit('7')">7</button>
                <button class="key" onclick="inputDigit('8')">8</button>
                <button class="key" onclick="inputDigit('9')">9</button>
                <button class="key" onclick="toggleNegative()">+/-</button>
                <button class="key" onclick="inputDigit('0')">0</button>
                <button class="key" onclick="backspace()">‚Üê</button>
            </div>
            <div class="action-buttons">
                <button class="btn btn-exit" onclick="exitPractice()">
                    ‚úï Exit
                </button>
                <button class="btn btn-enter" onclick="submitAnswer()">
                    ‚úì Enter
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <h1>üéâ Session Complete!</h1>
            <div class="stats" id="statsDisplay"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="retrySession()">
                    üîÑ Retry
                </button>
                <button class="btn btn-primary" onclick="goHome()">
                    üè† Go to Home
                </button>
                <button class="btn btn-secondary" onclick="closeApp()">
                    üëã Exit
                </button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeInfoModal()">√ó</button>
            <div class="modal-header">About Math Strong</div>
            <div class="modal-body">
                <p>We hope you enjoy this simple app and get better at math!</p>
                <p><strong>Version:</strong> 1.19</p>
                <p><strong>Contact:</strong><br>
                   s.kamma@live.com</p>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const MAX_TABLE_NUMBER = 12; // Maximum number for multiplication/division tables (0-12)
        const FEEDBACK_DURATION_CORRECT = 500; // Duration to show correct answer feedback (ms)
        const FEEDBACK_DURATION_INCORRECT = 1500; // Duration to show incorrect answer feedback (ms)

        // Game state
        let gameState = {
            mode: null, // 'multiplication', 'division', 'addition', or 'subtraction'
            table: null,
            range: null, // For addition/subtraction: { min, max }
            includeNegatives: false,
            currentQuestion: null,
            previousQuestion: null,
            totalProblems: 0,
            correctAnswers: 0,
            wrongAnswers: 0,
            wrongQuestions: [],
            startTime: null,
            questionStartTime: null,
            cumulativeAnswerTime: 0, // Total time actually spent answering questions
            isAnswering: true,
            showingFeedback: false,
            feedbackStartTime: null,
            totalFeedbackTime: 0, // Total time spent showing feedback messages
            showRunningStats: false,
            runningStatsInterval: null
        };

        // Initialize
        function init() {
            createTableSelector();
            setupKeyboardListeners();
        }

        // Create table selector buttons
        function createTableSelector() {
            const selector = document.getElementById('tableSelector');
            selector.innerHTML = ''; // Clear previous content
            selector.style.gridTemplateColumns = 'repeat(4, 1fr)'; // Ensure 4 columns
            for (let i = 0; i <= MAX_TABLE_NUMBER; i++) {
                const btn = document.createElement('button');
                btn.className = 'table-btn';
                btn.textContent = i;
                btn.onclick = () => selectTable(i);
                selector.appendChild(btn);
            }
        }

        // Setup keyboard event listeners
        function setupKeyboardListeners() {
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('practiceScreen').classList.contains('active') && gameState.isAnswering && !gameState.showingFeedback) {
                    if (e.key >= '0' && e.key <= '9') {
                        inputDigit(e.key);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        submitAnswer();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        exitPractice();
                    } else if (e.key === 'Backspace') {
                        e.preventDefault();
                        backspace();
                    } else if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        toggleNegative();
                    }
                }
            });
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function retrySession() {
            // Save current session settings
            const mode = gameState.mode;
            const table = gameState.table;
            const range = gameState.range;
            const includeNegatives = gameState.includeNegatives;
            
            // Reset game state
            resetGameState();
            
            // Restore session settings
            gameState.mode = mode;
            gameState.table = table;
            gameState.range = range;
            gameState.includeNegatives = includeNegatives;
            gameState.startTime = Date.now();
            
            // Start practice
            showScreen('practiceScreen');
            generateQuestion();
        }

        function goHome() {
            resetGameState();
            showScreen('homeScreen');
        }

        function closeApp() {
            if (confirm('Are you sure you want to exit?')) {
                window.close();
                // If window.close() doesn't work (browser restriction), show a message
                setTimeout(() => {
                    alert('Please close this tab/window to exit.');
                }, 100);
            }
        }

        // Create range selector for addition/subtraction
        function createRangeSelector() {
            const selector = document.getElementById('tableSelector');
            selector.innerHTML = '';
            const ranges = [
                { label: '0 - 10', min: 0, max: 10 },
                { label: '10 - 100', min: 10, max: 100 },
                { label: '100+', min: 100, max: 999 }
            ];
            ranges.forEach((range, index) => {
                const btn = document.createElement('button');
                btn.className = 'table-btn';
                btn.style.gridColumn = 'span 1';
                btn.textContent = range.label;
                btn.onclick = () => selectRange(range);
                selector.appendChild(btn);
            });
        }

        // Mode selection
        function selectMode(mode) {
            gameState.mode = mode;
            gameState.includeNegatives = document.getElementById('negativeCheckbox').checked;
            gameState.showRunningStats = document.getElementById('showRunningStatsCheckbox').checked;
            
            // Mix Everything mode - skip table selection and start immediately
            if (mode === 'mixall') {
                resetGameState();
                gameState.mode = 'mixall';
                gameState.startTime = Date.now();
                showScreen('practiceScreen');
                startRunningStats();
                generateQuestion();
                return;
            }
            
            const prompt = document.getElementById('tablePrompt');
            const title = document.getElementById('tableTitle');
            const mixAllBtn = document.getElementById('mixAllBtn');
            
            if (mode === 'multiplication') {
                title.textContent = 'Choose a Table';
                prompt.textContent = `Select a multiplication table (0-${MAX_TABLE_NUMBER})`;
                createTableSelector();
                mixAllBtn.style.display = 'block';
            } else if (mode === 'division') {
                title.textContent = 'Choose a Table';
                prompt.textContent = `Select a division table (0-${MAX_TABLE_NUMBER})`;
                createTableSelector();
                mixAllBtn.style.display = 'block';
            } else if (mode === 'addition') {
                title.textContent = 'Choose a Difficulty';
                prompt.textContent = 'Select a range for addition';
                createRangeSelector();
                mixAllBtn.style.display = 'none';
            } else if (mode === 'subtraction') {
                title.textContent = 'Choose a Difficulty';
                prompt.textContent = 'Select a range for subtraction';
                createRangeSelector();
                mixAllBtn.style.display = 'none';
            }
            showScreen('tableScreen');
        }

        // Table selection
        function selectTable(table) {
            gameState.table = table;
            resetGameState();
            gameState.table = table;
            gameState.mode = gameState.mode || 'multiplication';
            gameState.startTime = Date.now();
            showScreen('practiceScreen');
            startRunningStats();
            generateQuestion();
        }

        // Range selection for addition/subtraction
        function selectRange(range) {
            gameState.range = range;
            resetGameState();
            gameState.range = range;
            gameState.mode = gameState.mode;
            gameState.startTime = Date.now();
            showScreen('practiceScreen');
            startRunningStats();
            generateQuestion();
        }

        // Reset game state
        function resetGameState() {
            gameState = {
                mode: gameState.mode,
                table: gameState.table,
                range: gameState.range,
                includeNegatives: gameState.includeNegatives,
                currentQuestion: null,
                previousQuestion: null,
                totalProblems: 0,
                correctAnswers: 0,
                wrongAnswers: 0,
                wrongQuestions: [],
                startTime: null,
                questionStartTime: null,
                cumulativeAnswerTime: 0,
                isAnswering: true,
                showingFeedback: false,
                feedbackStartTime: null,
                totalFeedbackTime: 0,
                showRunningStats: gameState.showRunningStats,
                runningStatsInterval: null
            };
            clearInput();
        }

        // Apply random negatives to operands
        function applyRandomNegatives(num1, num2) {
            if (gameState.includeNegatives) {
                const negativePattern = Math.random();
                if (negativePattern < 0.33) {
                    // First number negative
                    num1 = -num1;
                } else if (negativePattern < 0.66) {
                    // Second number negative
                    num2 = -num2;
                } else {
                    // Both negative (or both positive if > 0.8)
                    
                        num1 = -num1;
                        num2 = -num2;
                    }
                
            }
            return [num1, num2];
        }

        // Running stats functions
        function updateRunningStats() {
            if (!gameState.showRunningStats) return;
            
            const elapsedTime = (Date.now() - gameState.startTime - gameState.totalFeedbackTime) / 1000;
            document.getElementById('runningTime').textContent = elapsedTime.toFixed(1) + 's';
            document.getElementById('runningCorrect').textContent = gameState.correctAnswers;
            document.getElementById('runningTotal').textContent = gameState.totalProblems;
        }

        function startRunningStats() {
            const runningStatsEl = document.getElementById('runningStats');
            if (gameState.showRunningStats) {
                runningStatsEl.classList.add('visible');
                // Update every 100ms
                gameState.runningStatsInterval = setInterval(updateRunningStats, 100);
            } else {
                runningStatsEl.classList.remove('visible');
            }
        }

        function stopRunningStats() {
            if (gameState.runningStatsInterval) {
                clearInterval(gameState.runningStatsInterval);
                gameState.runningStatsInterval = null;
            }
        }

        // Generate question
        function generateQuestion() {
            gameState.isAnswering = true;
            gameState.questionStartTime = Date.now();
            
            let num1, num2, answer, questionText;
            
            // Mix Everything mode - randomly choose an operation
            if (gameState.mode === 'mixall') {
                const operations = ['multiplication', 'division', 'addition', 'subtraction'];
                const randomOp = operations[Math.floor(Math.random() * operations.length)];
                
                if (randomOp === 'multiplication' || randomOp === 'division') {
                    // Random table multiplication/division (0-12)
                    num1 = Math.floor(Math.random() * (MAX_TABLE_NUMBER + 1));
                    num2 = Math.floor(Math.random() * (MAX_TABLE_NUMBER + 1));
                    
                    [num1, num2] = applyRandomNegatives(num1, num2);
                    
                    if (randomOp === 'multiplication') {
                        answer = num1 * num2;
                        questionText = `${num1} √ó ${num2} = ?`;
                    } else {
                        // For division, ensure divisor is not 0
                        if (num1 === 0) {
                            num1 = Math.floor(Math.random() * MAX_TABLE_NUMBER) + 1;
                            [num1, num2] = applyRandomNegatives(num1, num2);
                        }
                        const product = num1 * num2;
                        answer = num2;
                        questionText = `${product} √∑ ${num1} = ?`;
                    }
                } else {
                    // Random addition/subtraction (0-100)
                    num1 = Math.floor(Math.random() * 101);
                    num2 = Math.floor(Math.random() * 101);
                    
                    [num1, num2] = applyRandomNegatives(num1, num2);
                    
                    if (randomOp === 'addition') {
                        answer = num1 + num2;
                        questionText = `${num1} + ${num2} = ?`;
                    } else {
                        answer = num1 - num2;
                        questionText = `${num1} ‚àí ${num2} = ?`;
                    }
                }
            } else if (gameState.mode === 'multiplication' || gameState.mode === 'division') {
                // Retry wrong questions 30% of the time if available
                if (gameState.wrongQuestions.length > 0 && Math.random() < 0.3) {
                    const wrongQ = gameState.wrongQuestions[Math.floor(Math.random() * gameState.wrongQuestions.length)];
                    num1 = wrongQ.num1;
                    num2 = wrongQ.num2;
                } else {
                    num2 = Math.floor(Math.random() * (MAX_TABLE_NUMBER + 1)); // 0-MAX_TABLE_NUMBER
                    // If mix mode, randomly select a table number for num1
                    if (gameState.table === 'mix') {
                        num1 = Math.floor(Math.random() * (MAX_TABLE_NUMBER + 1)); // 0-MAX_TABLE_NUMBER
                    } else {
                        num1 = gameState.table;
                    }
                }

                // Apply negatives for multiplication/division
                [num1, num2] = applyRandomNegatives(num1, num2);

                // Make sure we don't repeat the same question twice in a row
                if (gameState.previousQuestion && 
                    gameState.previousQuestion.num1 === num1 && 
                    gameState.previousQuestion.num2 === num2) {
                    // Try a different number
                    num2 = (num2 + 1) % (MAX_TABLE_NUMBER + 1);
                    [num1, num2] = applyRandomNegatives(num1, num2);
                }

                if (gameState.mode === 'multiplication') {
                    answer = num1 * num2;
                    questionText = `${num1} √ó ${num2} = ?`;
                } else {
                    // Ensure divisor is never 0 - regenerate if needed
                    if (num1 === 0) {
                        num1 = Math.floor(Math.random() * MAX_TABLE_NUMBER) + 1; // 1-MAX_TABLE_NUMBER
                        [num1, num2] = applyRandomNegatives(num1, num2);
                    }
                    const product = num1 * num2;
                    const divisor = num1;
                    answer = num2;
                    
                    questionText = `${product} √∑ ${num1} = ?`;
                }
            } else if (gameState.mode === 'addition' || gameState.mode === 'subtraction') {
                // Generate numbers within the selected range
                const { min, max } = gameState.range;
                
                // Retry wrong questions 30% of the time if available
                if (gameState.wrongQuestions.length > 0 && Math.random() < 0.3) {
                    const wrongQ = gameState.wrongQuestions[Math.floor(Math.random() * gameState.wrongQuestions.length)];
                    num1 = wrongQ.num1;
                    num2 = wrongQ.num2;
                } else {
                    num1 = Math.floor(Math.random() * (max - min + 1)) + min;
                    num2 = Math.floor(Math.random() * (max - min + 1)) + min;
                }

                // Apply negatives for addition/subtraction
                [num1, num2] = applyRandomNegatives(num1, num2);

                // Make sure we don't repeat the same question twice in a row
                if (gameState.previousQuestion && 
                    gameState.previousQuestion.num1 === num1 && 
                    gameState.previousQuestion.num2 === num2) {
                    // Try a different number
                    num2 = Math.floor(Math.random() * (max - min + 1)) + min;
                    [num1, num2] = applyRandomNegatives(num1, num2);
                }

                if (gameState.mode === 'addition') {
                    answer = num1 + num2;
                    questionText = `${num1} + ${num2} = ?`;
                } else {
                    // For subtraction, answer can be negative
                    answer = num1 - num2;
                    questionText = `${num1} ‚àí ${num2} = ?`;
                }
            }

            gameState.currentQuestion = { num1, num2, answer, questionText };
            gameState.previousQuestion = { num1, num2 };
            
            document.getElementById('questionDisplay').textContent = questionText;
            clearInput();
        }

        // Input handling
        function inputDigit(digit) {
            if (!gameState.isAnswering || gameState.showingFeedback) return;
            const input = document.getElementById('answerInput');
            input.value += digit;
        }

        function toggleNegative() {
            if (!gameState.isAnswering || gameState.showingFeedback) return;
            const input = document.getElementById('answerInput');
            if (input.value === '') {
                input.value = '-';
            } else if (input.value.startsWith('-')) {
                input.value = input.value.substring(1);
            } else {
                input.value = '-' + input.value;
            }
        }

        function clearInput() {
            document.getElementById('answerInput').value = '';
        }

        function backspace() {
            if (!gameState.isAnswering || gameState.showingFeedback) return;
            const input = document.getElementById('answerInput');
            input.value = input.value.slice(0, -1);
        }

        // Show feedback overlay
        function showFeedbackOverlay(message, isCorrect) {
            gameState.showingFeedback = true;
            gameState.feedbackStartTime = Date.now();
            
            // Disable keypad and action buttons
            const keypad = document.querySelector('.keypad');
            const actionButtons = document.querySelector('.action-buttons');
            if (keypad) keypad.classList.add('disabled');
            if (actionButtons) actionButtons.classList.add('disabled');
            
            const overlay = document.createElement('div');
            overlay.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            overlay.textContent = message;
            document.body.appendChild(overlay);
            
            const feedbackDuration = isCorrect ? FEEDBACK_DURATION_CORRECT : FEEDBACK_DURATION_INCORRECT;
            
            setTimeout(() => {
                overlay.remove();
                gameState.showingFeedback = false;
                
                // Add feedback display time to total
                const actualFeedbackTime = Date.now() - gameState.feedbackStartTime;
                gameState.totalFeedbackTime += actualFeedbackTime;
                
                // Re-enable keypad and action buttons
                if (keypad) keypad.classList.remove('disabled');
                if (actionButtons) actionButtons.classList.remove('disabled');
            }, feedbackDuration);
        }

        // Submit answer
        function submitAnswer() {
            if (!gameState.isAnswering) return;
            
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            if (isNaN(userAnswer)) {
                return; // Don't process empty answers
            }

            // Record time spent on this question before stopping the timer
            const questionTime = (Date.now() - gameState.questionStartTime) / 1000;
            gameState.cumulativeAnswerTime += questionTime;
            
            gameState.isAnswering = false;
            gameState.totalProblems++;

            const correctAnswer = gameState.currentQuestion.answer;

            if (userAnswer === correctAnswer) {
                // Correct answer
                gameState.correctAnswers++;
                const encouragements = [
                    'üåü Excellent!',
                    'üéâ Perfect!',
                    'üëè Great job!',
                    'üíØ Awesome!',
                    '‚ú® Brilliant!',
                    'üöÄ You rock!',
                    '‚≠ê Fantastic!',
                    'üèÜ Outstanding!'
                ];
                const message = encouragements[Math.floor(Math.random() * encouragements.length)];
                showFeedbackOverlay(message, true);
                
                updateRunningStats();
                
                // Remove from wrong questions if it was there
                gameState.wrongQuestions = gameState.wrongQuestions.filter(
                    q => !(q.num1 === gameState.currentQuestion.num1 && q.num2 === gameState.currentQuestion.num2)
                );
                
                setTimeout(() => {
                    generateQuestion();
                }, FEEDBACK_DURATION_CORRECT);
            } else {
                // Wrong answer
                gameState.wrongAnswers++;
                const encouragements = [
                    `Not quite! The answer is ${correctAnswer}. Keep learning! üìö`,
                    `Oops! It's ${correctAnswer}. You'll get it next time! üí™`,
                    `Almost! The correct answer is ${correctAnswer}. Keep practicing! üåà`,
                    `Nice try! The answer is ${correctAnswer}. You're improving! üåü`,
                    `So close! It's ${correctAnswer}. Don't give up! üéØ`
                ];
                const message = encouragements[Math.floor(Math.random() * encouragements.length)];
                showFeedbackOverlay(message, false);
                
                updateRunningStats();
                
                // Add to wrong questions if not already there
                const exists = gameState.wrongQuestions.some(
                    q => q.num1 === gameState.currentQuestion.num1 && q.num2 === gameState.currentQuestion.num2
                );
                if (!exists) {
                    gameState.wrongQuestions.push({
                        num1: gameState.currentQuestion.num1,
                        num2: gameState.currentQuestion.num2
                    });
                }
                
                setTimeout(() => {
                    generateQuestion();
                }, FEEDBACK_DURATION_INCORRECT);
            }
        }

        // Exit practice
        function exitPractice() {
            // If there's a current answer, validate it first
            if (gameState.isAnswering && document.getElementById('answerInput').value) {
                submitAnswer();
            }
            
            // Show results after a brief delay
            setTimeout(() => {
                showResults();
            }, gameState.isAnswering ? 0 : 1000);
        }

        // Show results
        function showResults() {
            stopRunningStats();
            const totalElapsedTime = (Date.now() - gameState.startTime) / 1000; // in seconds
            const totalTime = totalElapsedTime - (gameState.totalFeedbackTime / 1000); // Subtract feedback display time
            const avgTime = gameState.totalProblems > 0 ? (gameState.cumulativeAnswerTime / gameState.totalProblems).toFixed(1) : 0;

            const statsHTML = `
                <div class="stat-row">
                    <span class="stat-label">Total Problems:</span>
                    <span class="stat-value">${gameState.totalProblems}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Correct Answers:</span>
                    <span class="stat-value" style="color: #4CAF50;">${gameState.correctAnswers}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wrong Answers:</span>
                    <span class="stat-value" style="color: #f44336;">${gameState.wrongAnswers}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Time:</span>
                    <span class="stat-value">${totalTime.toFixed(1)} seconds</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Time per Problem:</span>
                    <span class="stat-value">${avgTime} seconds</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Accuracy:</span>
                    <span class="stat-value">${gameState.totalProblems > 0 ? ((gameState.correctAnswers / gameState.totalProblems) * 100).toFixed(1) : 0}%</span>
                </div>
            `;

            document.getElementById('statsDisplay').innerHTML = statsHTML;
            showScreen('resultsScreen');
        }

        // Info modal functions
        function showInfoModal() {
            document.getElementById('infoModal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('infoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInfoModal();
            }
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>